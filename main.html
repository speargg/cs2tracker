<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Statistics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #0f1419 100%);
            background-attachment: fixed;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
            width: 100%;
        }

        .search-section {
            margin-bottom: 2rem;
            text-align: center;
            width: 100%;
        }

        /* Pełnoekranowy spinner */
        .fullscreen-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f1419;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Spinner animowany — WAŻNE: nie wewnątrz @media! */
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(255, 255, 255, 0.15);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(26, 35, 50, 0.8);
            backdrop-filter: blur(10px);
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(37, 99, 235, 0.3);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
            background: rgba(37, 99, 235, 0.3);
        }

        /* Black Theme - OLED Style */
        body.black-theme {
            background: linear-gradient(135deg, #000000 0%, #0d0d0d 25%, #1a1a1a 50%, #0d0d0d 75%, #000000 100%);
        }

        body.black-theme .rating-card,
        body.black-theme .stats-container,
        body.black-theme .chart-container,
        body.black-theme .matches-header,
        body.black-theme .matches-list {
            background: rgba(8, 8, 8, 0.95);
            border: 1px solid rgba(40, 40, 40, 0.5);
        }

        body.black-theme .stats-toggle {
            background: rgba(8, 8, 8, 0.95);
            border: 1px solid rgba(40, 40, 40, 0.5);
        }

        body.black-theme .toggle-btn.active {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 40, 40, 0.4);
        }

        body.black-theme .search-container {
            background: rgba(8, 8, 8, 0.95);
            border: 1px solid rgba(40, 40, 40, 0.5);
        }

        body.black-theme .social-link {
            background: rgba(8, 8, 8, 0.8);
            border: 1px solid rgba(40, 40, 40, 0.5);
        }

        body.black-theme .social-link:hover {
            background: rgba(25, 25, 25, 0.8);
            box-shadow: 0 5px 15px rgba(40, 40, 40, 0.6);
        }

        body.black-theme .match-card:hover {
            background: rgba(15, 15, 15, 0.8);
        }

        body.black-theme .ranking-item {
            background: rgba(15, 15, 15, 0.6);
            border-left: 3px solid rgba(80, 80, 80, 0.7);
        }

        body.black-theme .stat-row {
            border-bottom: 1px solid rgba(30, 30, 30, 0.5);
        }

        body.black-theme .stats-labels {
            border-bottom: 1px solid rgba(40, 40, 40, 0.6);
        }

        body.black-theme .match-card {
            border-bottom: 1px solid rgba(25, 25, 25, 0.4);
        }

        body.black-theme .expand-btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            border: 1px solid rgba(40, 40, 40, 0.4);
        }

        body.black-theme .expand-btn:hover {
            box-shadow: 0 10px 25px rgba(40, 40, 40, 0.6);
        }

        body.black-theme .theme-toggle {
            background: rgba(8, 8, 8, 0.9);
            border: 1px solid rgba(40, 40, 40, 0.5);
        }

        body.black-theme .theme-toggle:hover {
            background: rgba(25, 25, 25, 0.9);
            box-shadow: 0 8px 20px rgba(40, 40, 40, 0.6);
        }

        .search-container {
            display: flex;
            max-width: 500px;
            margin: 0 auto 0.75rem;
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 16px;
            padding: 0.5rem;
            backdrop-filter: blur(10px);
            width: 100%;
            box-sizing: border-box;
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        .search-btn {
            background: transparent;
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .search-hint {
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 400;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            width: 100%;
        }

        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 600;
            border: 4px solid rgba(37, 99, 235, 0.2);
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
        }

        .nickname {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .social-link {
            width: 40px;
            height: 40px;
            background: rgba(37, 99, 235, 0.15);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #fff;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            padding: 0;
            overflow: hidden;
        }
.social-link img {
    width: 16px !important;
    height: 16px !important;
    max-width: 16px !important;
    max-height: 16px !important;
}

        .social-link:hover {
            background: rgba(37, 99, 235, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        .ratings {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .rating-card {
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 16px;
            padding: 2rem;
            min-width: 250px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .rating-title {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .rating-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .premier-rating {
            color: #60a5fa;
        }

        .faceit-rating {
            color: #3b82f6;
        }

        .rating-elo {
            font-size: 1.25rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .rating-season {
            font-size: 1.25rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .ranking {
            padding-top: 1rem;
            border-top: 1px solid rgba(37, 99, 235, 0.2);
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 8px;
            border-left: 3px solid rgba(37, 99, 235, 0.5);
        }

        .ranking-item:last-child {
            margin-bottom: 0;
        }

        .ranking-label {
            font-size: 0.75rem;
            color: #94a3b8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ranking-value {
            font-size: 0.875rem;
            color: #e2e8f0;
            font-weight: 600;
        }

        .stats-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
            color: #fff;
            letter-spacing: -1px;
        }

        /* Leetify Statistics Section */
        .leetify-stats {
            margin-bottom: 2rem;
        }

        .leetify-stats .section-title {
            color: #f59e0b;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
        }

        .leetify-container {
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .leetify-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .leetify-stat-card {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .leetify-stat-label {
            font-size: 0.75rem;
            color: #f59e0b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .leetify-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
        }

        .leetify-stat-subtitle {
            font-size: 0.625rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        /* FACEIT Statistics Section */
        .faceit-stats {
            margin-bottom: 2rem;
        }

        .faceit-stats .section-title {
            color: #3b82f6;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
        }

        .faceit-container {
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .faceit-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .faceit-stat-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .faceit-stat-label {
            font-size: 0.75rem;
            color: #3b82f6;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .faceit-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
        }

        .performance-section {
            margin-bottom: 3rem;
        }

        .chart-container {
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 16px;
            padding: 2rem;
            height: 300px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .elo-change {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(37, 99, 235, 0.2);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .elo-positive {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }

        .elo-negative {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Enhanced Recent Matches Section */
        .matches-section {
            margin-bottom: 2rem;
        }

        .matches-container {
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .matches-header {
            display: grid;
            grid-template-columns: 5fr 2fr 5fr;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(37, 99, 235, 0.2);
            background: rgba(37, 99, 235, 0.1);
        }

        .matches-header-left {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .matches-header-center {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .matches-header-right {
            display: flex;
            justify-content: flex-end;
            gap: 2rem;
        }

        .matches-header-right > div {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 50px;
            text-align: center;
        }

        .match-card {
            display: grid;
            grid-template-columns: 5fr 2fr 5fr;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(37, 99, 235, 0.1);
            transition: all 0.3s ease;
        }

        .match-card:last-child {
            border-bottom: none;
        }

        .match-card:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .match-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .match-result {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .win {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .loss {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .ongoing {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            border-color: rgba(107, 114, 128, 0.3);
        }

        .match-info {
            flex: 1;
            min-width: 0;
        }

        .match-date-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .match-date-icon {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .match-date {
            font-size: 0.875rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .match-details-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .match-map {
            font-size: 1rem;
            color: #fff;
            font-weight: 600;
        }

        .elo-change-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .elo-change-positive {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .elo-change-negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .elo-icon {
            width: 12px;
            height: 12px;
        }

        .match-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            text-align: center;
            white-space: nowrap;
        }

        .match-stats {
            display: flex;
            justify-content: flex-end;
            gap: 2rem;
        }

        .match-stat-value {
            font-weight: 600;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            min-width: 50px;
        }

        .expand-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 2rem auto 0;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .expand-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }

        .hidden-matches {
            display: none;
        }

        @media (max-width: 768px) {
            .nickname {
                font-size: 2.5rem;
            }

            .ratings {
                flex-direction: column;
                gap: 1rem;
            }

            .rating-card {
                min-width: auto;
            }

            .leetify-stats-grid,
            .faceit-stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.75rem;
            }

            .leetify-stat-card,
            .faceit-stat-card {
                padding: 0.75rem;
            }

            .leetify-stat-value,
            .faceit-stat-value {
                font-size: 1.1rem;
            }

            .matches-header {
                grid-template-columns: 2fr 1fr 2fr;
                padding: 1rem;
                gap: 0.5rem;
            }

            .matches-header-right {
                gap: 1rem;
            }

            .matches-header-right > div {
                min-width: 40px;
                font-size: 0.75rem;
            }

            .match-card {
                grid-template-columns: 2fr 1fr 2fr;
                padding: 1rem;
                gap: 0.5rem;
            }

            .match-left {
                gap: 0.75rem;
            }

            .match-result {
                width: 32px;
                height: 32px;
                font-size: 0.875rem;
            }

            .match-details-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .match-map {
                font-size: 0.875rem;
            }

            .match-score {
                font-size: 1.25rem;
            }

            .match-stats {
                gap: 1rem;
            }

            .match-stat-value {
                font-size: 0.875rem;
                min-width: 40px;
            }

            .elo-change-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }

        /* Theme Toggle Button - Non-interfering */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 1px solid rgba(37, 99, 235, 0.3);
            background: rgba(26, 35, 50, 0.8);
            backdrop-filter: blur(10px);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 !important;
            padding: 0 !important;
            float: none !important;
            clear: none !important;
            transform: none;
        }

        .theme-toggle:hover {
            background: rgba(37, 99, 235, 0.3);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        body {
            position: relative;
        }

        .container {
            position: static;
        }

        .avatar {
            margin: 0 auto;
        }

        .social-links {
            margin: 0.75rem 0 1rem;
        }

        .avatar-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .avatar-wrapper .rating-card {
            background: rgba(26, 35, 50, 0.6);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            text-align: center;
            backdrop-filter: blur(10px);
            min-width: 220px;
        }

        .header .nickname {
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 3rem;
        }

        /* Blokuje przewijanie i przesuwanie layoutu, dopóki nie zniknie loader */
        body.loading {
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 0 15px;
            }
        }
    </style>
</head>
<body>

<!-- Loader -->
<div id="loader" class="fullscreen-loader">
  <div class="spinner"></div>
</div>

<!-- Ukryty kontent gracza -->
<div id="content" style="display: none;">
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <!-- Search Bar Section -->
            <div class="search-section">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Enter Steam ID or Faceit nickname...">
                    <button class="search-btn" onclick="searchPlayer()">
                        <img src="https://speargg.github.io/cs2tracker/assets/img/search.png" alt="Search" style="width: 20px; height: 20px; object-fit: contain;">
                    </button>
                </div>
                <div class="search-hint">Find any player profile using their Steam ID or Faceit nickname</div>
            </div>

            <!-- Avatar + Ratings -->
            <div class="avatar-wrapper">
                <div class="rating-card cs2-premier">
                    <div class="rating-title">CS2 Premier</div>
                    <div class="rating-value premier-rating">24,687</div>
                    <div class="rating-season">Season 2</div>
                </div>

                <div class="avatar">NK</div>

                <div class="rating-card faceit">
                    <div class="rating-title">Faceit</div>
                    <div class="rating-value faceit-rating">2,834</div>
                    <div class="rating-elo">Level 10</div>
                </div>
            </div>
            <!-- Nickname is now below everything -->
            <h1 class="nickname">NiKo_CS</h1>
            <!-- Social links moved above nickname -->
            <div class="social-links">
                <a href="#" class="social-link">
                    <img src="https://speargg.github.io/cs2tracker/assets/img/steam.png" alt="Steam">
                </a>
                <a href="#" class="social-link">
                    <img src="https://speargg.github.io/cs2tracker/assets/img/faceit.png" alt="Faceit">
                </a>
                <a href="#" class="social-link">
                    <img src="https://speargg.github.io/cs2tracker/assets/img/leetify.png" alt="Leetify">
                </a>
                <a href="#" class="social-link">
                    <img src="https://speargg.github.io/cs2tracker/assets/img/csstats.png" alt="CS Stats">
                </a>
            </div>
        </div>

        <!-- Leetify Statistics Section -->
        <div class="leetify-stats">
            <h2 class="section-title">Leetify Statistics</h2>
            <div class="leetify-container">
                <div class="leetify-stats-grid">
                    <div class="leetify-stat-card">
                        <div class="leetify-stat-label">Rating</div>
                        <div class="leetify-stat-value" id="leetify-rating">7.29</div>
                    </div>
                    <div class="leetify-stat-card">
                        <div class="leetify-stat-label">Matches</div>
                        <div class="leetify-stat-value" id="leetify-matches">3,882</div>
                    </div>
                    <div class="leetify-stat-card">
                        <div class="leetify-stat-label">Winrate</div>
                        <div class="leetify-stat-value" id="leetify-winrate">78%</div>
                    </div>
                    <div class="leetify-stat-card">
                        <div class="leetify-stat-label">Aim</div>
                        <div class="leetify-stat-value" id="leetify-aim">81</div>
                    </div>
                    <div class="leetify-stat-card">
                        <div class="leetify-stat-label">Utility</div>
                        <div class="leetify-stat-value" id="leetify-utility">63</div>
                    </div>
                    <div class="leetify-stat-card">
                        <div class="leetify-stat-label">Reaction Time</div>
                        <div class="leetify-stat-value" id="leetify-reaction">N/A</div>
                        <div class="leetify-stat-subtitle">ms</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FACEIT Statistics Section -->
        <div class="faceit-stats">
            <h2 class="section-title">FACEIT Statistics</h2>
            <div class="faceit-container">
                <div class="faceit-stats-grid">
                    <div class="faceit-stat-card">
                        <div class="faceit-stat-label">K/D</div>
                        <div class="faceit-stat-value" id="faceit-kd">1.24</div>
                    </div>
                    <div class="faceit-stat-card">
                        <div class="faceit-stat-label">ADR</div>
                        <div class="faceit-stat-value" id="faceit-adr">91.87</div>
                    </div>
                    <div class="faceit-stat-card">
                        <div class="faceit-stat-label">Matches</div>
                        <div class="faceit-stat-value" id="faceit-matches">2,156</div>
                    </div>
                    <div class="faceit-stat-card">
                        <div class="faceit-stat-label">Winrate</div>
                        <div class="faceit-stat-value" id="faceit-winrate">67%</div>
                    </div>
                    <div class="faceit-stat-card">
                        <div class="faceit-stat-label">HS%</div>
                        <div class="faceit-stat-value" id="faceit-hs">54%</div>
                    </div>
                    <div class="faceit-stat-card">
                        <div class="faceit-stat-label">Win Streak</div>
                        <div class="faceit-stat-value" id="faceit-streak">12</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Graph Section -->
        <div class="performance-section">
            <h2 class="section-title">Faceit ELO over last 20 Matches</h2>
            <div class="chart-container">
                <div class="elo-change" id="eloChange">+78 ELO</div>
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Enhanced Recent Matches Section -->
        <div class="matches-section">
            <h2 class="section-title">Recent 5v5 Matches</h2>
            
            <div class="matches-container">
                <div class="matches-header">
                    <div class="matches-header-left">MATCH INFO</div>
                    <div class="matches-header-center">SCORE</div>
                    <div class="matches-header-right">
                        <div>K/D</div>
                        <div>ADR</div>
                        <div>HS%</div>
                    </div>
                </div>

                <div class="matches-list" id="matchesList">
                    <!-- Sample matches - will be replaced by JavaScript -->
                    <div class="match-card">
                        <div class="match-left">
                            <div class="match-result win">W</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 16</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Mirage</span>
                                    <div class="elo-change-badge elo-change-positive">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        +26 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">16:12</div>
                        <div class="match-stats">
                            <div class="match-stat-value">1.50</div>
                            <div class="match-stat-value">92.4</div>
                            <div class="match-stat-value">54%</div>
                        </div>
                    </div>

                    <div class="match-card">
                        <div class="match-left">
                            <div class="match-result loss">L</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 15</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Dust 2</span>
                                    <div class="elo-change-badge elo-change-negative">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        -18 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">13:16</div>
                        <div class="match-stats">
                            <div class="match-stat-value">0.90</div>
                            <div class="match-stat-value">78.9</div>
                            <div class="match-stat-value">47%</div>
                        </div>
                    </div>

                    <div class="match-card">
                        <div class="match-left">
                            <div class="match-result win">W</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 14</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Inferno</span>
                                    <div class="elo-change-badge elo-change-positive">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        +31 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">16:9</div>
                        <div class="match-stats">
                            <div class="match-stat-value">1.93</div>
                            <div class="match-stat-value">105.2</div>
                            <div class="match-stat-value">61%</div>
                        </div>
                    </div>

                    <div class="match-card">
                        <div class="match-left">
                            <div class="match-result win">W</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 13</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Cache</span>
                                    <div class="elo-change-badge elo-change-positive">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        +22 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">16:11</div>
                        <div class="match-stats">
                            <div class="match-stat-value">1.29</div>
                            <div class="match-stat-value">88.7</div>
                            <div class="match-stat-value">49%</div>
                        </div>
                    </div>

                    <div class="match-card">
                        <div class="match-left">
                            <div class="match-result loss">L</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 12</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Overpass</span>
                                    <div class="elo-change-badge elo-change-negative">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        -15 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">14:16</div>
                        <div class="match-stats">
                            <div class="match-stat-value">1.05</div>
                            <div class="match-stat-value">82.1</div>
                            <div class="match-stat-value">45%</div>
                        </div>
                    </div>

                    <!-- Hidden matches for "Show More" functionality -->
                    <div class="match-card hidden-matches">
                        <div class="match-left">
                            <div class="match-result win">W</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 11</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Ancient</span>
                                    <div class="elo-change-badge elo-change-positive">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        +28 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">16:8</div>
                        <div class="match-stats">
                            <div class="match-stat-value">1.67</div>
                            <div class="match-stat-value">98.3</div>
                            <div class="match-stat-value">56%</div>
                        </div>
                    </div>

                    <div class="match-card hidden-matches">
                        <div class="match-left">
                            <div class="match-result loss">L</div>
                            <div class="match-info">
                                <div class="match-date-row">
                                    <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="match-date">Jun 10</span>
                                </div>
                                <div class="match-details-row">
                                    <span class="match-map">Vertigo</span>
                                    <div class="elo-change-badge elo-change-negative">
                                        <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        -21 ELO
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="match-score">12:16</div>
                        <div class="match-stats">
                            <div class="match-stat-value">0.85</div>
                            <div class="match-stat-value">74.6</div>
                            <div class="match-stat-value">43%</div>
                        </div>
                    </div>
                </div>

                <button class="expand-btn" onclick="toggleMoreMatches()">Show More Matches</button>
            </div>
        </div>
    </div>
</div>

<script>
    let isMatchesExpanded = false;
    let currentStatsPlatform = 'leetify';
    let currentLeetifyData = null;
    let performanceChart;
    let playerData = null;
    let eloHistory = [];

    // Create and inject theme toggle button
    document.addEventListener('DOMContentLoaded', function() {
        const shouldShowLoader = localStorage.getItem('showLoader') === 'true';
        const loader = document.getElementById('loader');
        const content = document.getElementById('content');

        if (shouldShowLoader && loader && content) {
            loader.style.display = 'flex';
            content.style.display = 'none';
            document.body.classList.add('loading');
        }

        localStorage.removeItem('showLoader');

        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'theme-toggle';
        toggleBtn.onclick = toggleTheme;
        toggleBtn.innerHTML = '<span class="theme-icon">🌙</span>';
        document.body.appendChild(toggleBtn);

        const savedTheme = localStorage.getItem('theme');
        const themeIcon = toggleBtn.querySelector('.theme-icon');

        if (savedTheme === 'black') {
            document.body.classList.add('black-theme');
            themeIcon.textContent = '☀️';
        }

        // Initialize chart
        setTimeout(() => {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) {
                console.error('❌ Nie znaleziono elementu #performanceChart!');
                return;
            }

            const ctx = canvas.getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Faceit ELO',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 20, 25, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(37, 99, 235, 0.3)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            multiKeyBackground: 'transparent'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                stepSize: 100,
                                color: '#94a3b8',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(37, 99, 235, 0.2)' }
                        },
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(37, 99, 235, 0.2)' }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            console.log('✅ Wykres został zainicjowany');
        }, 0);

        // Handle URL nickname
        let nickname = window.location.pathname.replace(/^\/+|\/+$/g, '');
        if (nickname && nickname !== 'main.html' && nickname !== 'index.html') {
            const input = document.querySelector('.search-input');
            if (input) {
                input.value = nickname;
                searchPlayer(false);
            }
        } else {
            if (loader && content) {
                loader.style.display = 'none';
                content.style.display = 'block';
                document.body.classList.remove('loading');
            }
        }
    });

    // Theme toggle functionality
    function toggleTheme() {
        const body = document.body;
        const themeIcon = document.querySelector('.theme-icon');
        
        body.classList.toggle('black-theme');
        
        if (body.classList.contains('black-theme')) {
            themeIcon.textContent = '☀️';
            localStorage.setItem('theme', 'black');
        } else {
            themeIcon.textContent = '🌙';
            localStorage.setItem('theme', 'blue');
        }
    }

    // Add enter key support for search
    document.querySelector('.search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPlayer();
        }
    });

    // API configuration
    const API_BASE_URL = '/.netlify/functions';

    // Main search function
    async function searchPlayer(showSpinner = true) {
        console.log("🔍 Starting search...");
        
        const searchInput = document.querySelector('.search-input');
        const query = searchInput.value.trim();
        
        if (!query) {
            alert('Please enter a Faceit nickname or Steam ID 64');
            return;
        }

        window.history.pushState({}, '', `/${query}`);
        console.log("🔍 Searching for:", query);
        
        const searchBtn = document.querySelector('.search-btn');
        const originalContent = searchBtn.innerHTML;
        
        try {
            if (showSpinner) {
                searchBtn.innerHTML = `
                    <div style="
                        width: 16px;
                        height: 16px;
                        border: 2px solid #fff;
                        border-top: 2px solid transparent;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    "></div>
                `;
                await new Promise(requestAnimationFrame);
            }
            
            console.log("📡 Fetching player data...");
            playerData = await fetchPlayerData(query);
            console.log("✅ Player data received:", playerData);
            
            console.log("📊 Fetching player stats...");
            const playerStats = await fetchPlayerStats(playerData.player_id);
            console.log("✅ Player stats received:", playerStats);
            
            console.log("🎮 Fetching match history...");
            const matchHistory = await fetchMatchHistory(playerData.player_id);
            console.log("✅ Match history received:", matchHistory);
            
            console.log("📈 Fetching ELO history...");
            await fetchEloHistory(playerData.player_id);
            console.log("✅ ELO history received");
            
            console.log("🔄 Updating player profile...");
            updatePlayerProfile(playerData, playerStats, matchHistory);
            console.log("✅ Player profile updated");
            
            console.log("📈 Updating performance chart...");
            if (typeof updatePerformanceChart === 'function') {
                await updatePerformanceChart(null, playerData.player_id);
                console.log("✅ Performance chart updated");
            }
            
        } catch (error) {
            console.error("❌ Error in searchPlayer:", error);
            alert('Player not found or API error. Please try again.');
        } finally {
            searchBtn.innerHTML = originalContent;
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            if (loader && content) {
                loader.style.display = 'none';
                content.style.display = 'block';
                document.body.classList.remove('loading');
            }
            console.log("🏁 Search process finished");
        }
    }

    // Fetch functions
    async function fetchPlayerData(nickname) {
        try {
            const response = await fetch(`${API_BASE_URL}/player?nickname=${encodeURIComponent(nickname)}`);
            if (!response.ok) {
                throw new Error(`Player not found (${response.status})`);
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch player data error:', error);
            throw error;
        }
    }

    async function fetchPlayerStats(playerId) {
        try {
            const response = await fetch(`${API_BASE_URL}/stats?playerId=${encodeURIComponent(playerId)}`);
            if (!response.ok) {
                throw new Error(`Stats not found (${response.status})`);
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch player stats error:', error);
            throw error;
        }
    }

    async function fetchMatchHistory(playerId) {
        try {
            const response = await fetch(`${API_BASE_URL}/matches?playerId=${encodeURIComponent(playerId)}`);
            if (!response.ok) {
                throw new Error(`Match history not found (${response.status})`);
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch match history error:', error);
            throw error;
        }
    }

    async function fetchEloHistory(playerId) {
        try {
            console.log('📈 Fetching ELO history for player:', playerId);
            const response = await fetch(`${API_BASE_URL}/faceit-elo?playerId=${encodeURIComponent(playerId)}`);
            
            if (!response.ok) {
                throw new Error(`ELO API error: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('✅ ELO data received:', data);
            
            eloHistory = data;
            return data;
        } catch (error) {
            console.error('❌ Error fetching ELO history:', error);
            eloHistory = [];
            return [];
        }
    }

    // Update player profile
    function updatePlayerProfile(playerData, playerStats, matchHistory) {
        try {
            // Update header info
            if (playerData?.nickname) {
                document.querySelector('.nickname').textContent = playerData.nickname;
                const avatarContainer = document.querySelector('.avatar');
                if (avatarContainer) {
                    if (playerData.avatar) {
                        avatarContainer.innerHTML = `<img src="${playerData.avatar}" alt="Player avatar" />`;
                    } else {
                        avatarContainer.textContent = playerData.nickname.charAt(0).toUpperCase();
                    }
                }
            }

            // Update FACEIT statistics
            if (playerStats?.lifetime) {
                const stats = playerStats.lifetime;
                updateStatSafely('faceit-kd', stats, ['Average K/D Ratio'], 'N/A', val => parseFloat(val).toFixed(2));
                updateStatSafely('faceit-adr', stats, ['ADR'], 'N/A', val => Math.round(parseFloat(val)));
                updateStatSafely('faceit-matches', stats, ['Matches'], 'N/A', val => parseInt(val).toLocaleString());
                updateStatSafely('faceit-winrate', stats, ['Win Rate %'], 'N/A', val => Math.round(parseFloat(val)) + '%');
                updateStatSafely('faceit-hs', stats, ['Average Headshots %'], 'N/A', val => Math.round(parseFloat(val)) + '%');
                updateStatSafely('faceit-streak', stats, ['Longest Win Streak'], 'N/A', val => parseInt(val));
            }

            // Update header ratings
            if (playerData?.games?.cs2?.faceit_elo) {
                const faceitElement = document.querySelector('.faceit-rating');
                const levelElement = document.querySelector('.rating-elo');
                if (faceitElement) {
                    faceitElement.textContent = Math.round(playerData.games.cs2.faceit_elo).toString();
                }
                if (levelElement && playerData.games.cs2.skill_level) {
                    levelElement.textContent = `Level ${playerData.games.cs2.skill_level}`;
                }
            }

            // Update matches
            if (matchHistory?.items) {
                updateMatchHistory(matchHistory.items, playerData.player_id);
            }

        } catch (error) {
            console.error("❌ Error updating player profile:", error);
        }
    }

    function updateStatSafely(elementId, source, keys, fallback = 'N/A', transform = val => val) {
        try {
            let value = source;
            for (let key of keys) {
                if (value && key in value) {
                    value = value[key];
                } else {
                    value = null;
                    break;
                }
            }
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value != null ? transform(value) : fallback;
            }
        } catch (e) {
            console.warn(`⚠️ Failed to update stat: ${elementId}`, e);
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = fallback;
            }
        }
    }

    // Update match history with ELO integration
    async function updateMatchHistory(matches, playerId) {
        const matchesList = document.getElementById('matchesList');
        isMatchesExpanded = false;
        const expandBtn = document.querySelector('.expand-btn');
        if (expandBtn) {
            expandBtn.textContent = 'Show More Matches';
        }

        // Clear existing matches
        matchesList.innerHTML = '';

        // Filter only 5v5 matches
        const fiveVFiveMatches = matches.filter(match => 
            match.game_mode === '5v5' || match.game_mode === 'matchmaking'
        );

        // Split into visible and hidden
        const visibleMatches = fiveVFiveMatches.slice(0, 5);
        const hiddenMatches = fiveVFiveMatches.slice(5, 10);

        // Create visible match cards
        visibleMatches.forEach((match, index) => {
            const matchCard = createMatchCard(match, playerId, index);
            matchesList.appendChild(matchCard);
        });

        // Create hidden match cards
        hiddenMatches.forEach((match, index) => {
            const matchCard = createMatchCard(match, playerId, index + 5);
            matchCard.classList.add('hidden-matches');
            matchCard.style.display = 'none';
            matchesList.appendChild(matchCard);
        });
    }

    // Create match card with ELO integration
    function createMatchCard(match, playerId, matchIndex) {
        const matchCard = document.createElement('div');
        matchCard.className = 'match-card';
        
        try {
            // Determine player team and result
            let playerTeam = null;
            if (match.teams?.faction1?.players?.some(p => p.player_id === playerId)) {
                playerTeam = 'faction1';
            } else if (match.teams?.faction2?.players?.some(p => p.player_id === playerId)) {
                playerTeam = 'faction2';
            }

            const result = determineMatchResult(match, playerTeam);
            const dateDisplay = formatMatchDate(match);
            const mapName = getMapName(match);
            const score = getMatchScore(match, playerTeam);
            const eloChange = getEloChange(matchIndex);

            matchCard.innerHTML = `
                <div class="match-left">
                    <div class="match-result ${result.class}">${result.symbol}</div>
                    <div class="match-info">
                        <div class="match-date-row">
                            <svg class="match-date-icon" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="match-date">${dateDisplay}</span>
                        </div>
                        <div class="match-details-row">
                            <span class="match-map">${mapName}</span>
                            ${eloChange ? `
                                <div class="elo-change-badge ${eloChange.class}">
                                    <svg class="elo-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="${eloChange.value > 0 ? 'M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z' : 'M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z'}" clip-rule="evenodd"></path>
                                    </svg>
                                    ${eloChange.display} ELO
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="match-score">${score}</div>
                <div class="match-stats">
                    <div class="match-stat-value">1.24</div>
                    <div class="match-stat-value">89.2</div>
                    <div class="match-stat-value">52%</div>
                </div>
            `;

        } catch (error) {
            console.error('Error creating match card:', error);
            matchCard.innerHTML = `
                <div class="match-left">
                    <div class="match-result loss">L</div>
                    <div class="match-info">
                        <div class="match-date-row">
                            <span class="match-date">Unknown</span>
                        </div>
                        <div class="match-details-row">
                            <span class="match-map">Unknown Match</span>
                        </div>
                    </div>
                </div>
                <div class="match-score">- : -</div>
                <div class="match-stats">
                    <div class="match-stat-value">-</div>
                    <div class="match-stat-value">-</div>
                    <div class="match-stat-value">-</div>
                </div>
            `;
        }
        
        return matchCard;
    }

    // Helper functions
    function determineMatchResult(match, playerTeam) {
        if (match.status === 'finished' && match.results && playerTeam) {
            if (match.results.winner === playerTeam) {
                return { symbol: 'W', class: 'win' };
            } else {
                return { symbol: 'L', class: 'loss' };
            }
        } else if (match.status === 'ongoing') {
            return { symbol: '?', class: 'ongoing' };
        } else {
            return { symbol: 'L', class: 'loss' };
        }
    }

    function formatMatchDate(match) {
        if (match.started_at || match.finished_at) {
            const timestamp = match.started_at || match.finished_at;
            const matchDate = new Date(timestamp * 1000);
            return matchDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
        return 'Unknown';
    }

    function getMapName(match) {
        if (match.voting?.map?.entities?.[0]?.game_map_id) {
            return cleanMapName(match.voting.map.entities[0].game_map_id);
        }
        if (match.voting?.map?.name) {
            return cleanMapName(match.voting.map.name);
        }
        return 'Unknown Map';
    }

    function cleanMapName(mapName) {
        if (!mapName) return 'Unknown';
        return mapName.replace(/^(de_|cs_|ar_)/, '').replace(/_/g, ' ')
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }

    function getMatchScore(match, playerTeam) {
        if (!match.results?.score || !playerTeam) return '- : -';
        
        const playerScore = match.results.score[playerTeam] || 0;
        const enemyTeam = playerTeam === 'faction1' ? 'faction2' : 'faction1';
        const enemyScore = match.results.score[enemyTeam] || 0;
        
        return `${playerScore}:${enemyScore}`;
    }

    function getEloChange(matchIndex) {
        if (!eloHistory.length || matchIndex >= eloHistory.length) return null;
        
        const eloChange = eloHistory[matchIndex]?.eloDiff;
        if (!eloChange) return null;
        
        return {
            value: eloChange,
            display: eloChange > 0 ? `+${eloChange}` : `${eloChange}`,
            class: eloChange > 0 ? 'elo-change-positive' : 'elo-change-negative'
        };
    }

    // Performance chart update
    async function updatePerformanceChart(_, playerId) {
        if (!performanceChart) {
            console.warn("⚠️ performanceChart not ready, retrying...");
            setTimeout(() => updatePerformanceChart(_, playerId), 200);
            return;
        }

        console.log("📈 Updating ELO chart for player:", playerId);

        try {
            if (eloHistory.length === 0) {
                await fetchEloHistory(playerId);
            }

            if (eloHistory.length === 0) {
                console.warn("⚠️ No ELO data available");
                return;
            }

            const chartData = eloHistory
                .filter(item => item.elo && item.date)
                .map(item => {
                    const date = new Date(item.date);
                    const label = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return { elo: item.elo, label };
                })
                .reverse();

            const labels = chartData.map(d => d.label);
            const values = chartData.map(d => d.elo);

            const minElo = Math.min(...values);
            const maxElo = Math.max(...values);
            const padding = Math.max((maxElo - minElo) * 0.2, 150);

            performanceChart.options.scales.y.min = Math.max(0, Math.floor(minElo - padding));
            performanceChart.options.scales.y.max = Math.min(5000, Math.ceil(maxElo + padding));
            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = values;
            performanceChart.update();

            updateEloChange();

            console.log("✅ ELO chart updated");

        } catch (err) {
            console.error("❌ Error updating ELO chart:", err);
        }
    }

    function updateEloChange() {
        if (!performanceChart.data.datasets[0].data.length) return;
        
        const firstElo = performanceChart.data.datasets[0].data[0];
        const lastElo = performanceChart.data.datasets[0].data[performanceChart.data.datasets[0].data.length - 1];
        const change = lastElo - firstElo;
        const eloChangeElement = document.getElementById('eloChange');
        
        if (eloChangeElement) {
            if (change >= 0) {
                eloChangeElement.textContent = `+${change} ELO`;
                eloChangeElement.className = 'elo-change elo-positive';
            } else {
                eloChangeElement.textContent = `${change} ELO`;
                eloChangeElement.className = 'elo-change elo-negative';
            }
        }
    }

    // Toggle more matches
    function toggleMoreMatches() {
        const hiddenMatches = document.querySelectorAll('.match-card.hidden-matches');
        const expandBtn = document.querySelector('.expand-btn');
        
        if (!hiddenMatches.length || !expandBtn) return;
        
        if (isMatchesExpanded) {
            hiddenMatches.forEach(match => {
                match.style.display = 'none';
            });
            expandBtn.textContent = 'Show More Matches';
            isMatchesExpanded = false;
        } else {
            hiddenMatches.forEach(match => {
                match.style.display = 'grid';
            });
            expandBtn.textContent = 'Show Less Matches';
            isMatchesExpanded = true;
        }
    }
</script>
</body>
</html>
